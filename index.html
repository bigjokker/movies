<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Movies</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=1">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #121212; color: #e0e0e0; }
        ul { list-style-type: none; padding: 0; }
        li { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; align-items: flex-start; }
        .poster { flex-shrink: 0; margin-right: 10px; width: 120px; height: 180px; }
        .poster img { width: 100%; height: 100%; object-fit: cover; }
        .placeholder { width: 100%; height: 100%; background-color: #333; display: flex; align-items: center; justify-content: center; font-size: 3em; color: #666; font-weight: bold; }
        .middle { flex: 1; margin-right: 10px; max-width: 500px; }
        .right-side { flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; }
        h1, h3 { color: #ffffff; }
        h3 { margin-bottom: 5px; font-size: 1.1em; }
        p { margin-top: 0; }
        .rating { font-weight: bold; margin-top: 5px; color: #ffffff; font-size: 0.9em; text-align: right; }
        .overview { color: #d0d0d0; position: relative; cursor: pointer; }
        button { background-color: #333; color: #e0e0e0; border: 1px solid #444; padding: 5px 10px; cursor: pointer; margin-left: 5px; }
        button:hover { background-color: #444; }
        #errorBox { background: #300; color: #f88; padding: 10px; margin-bottom: 10px; border: 1px solid #600; display: none; }
        #header { display: flex; justify-content: space-between; align-items: center; }
        #headerButtons { display: flex; gap: 5px; }
        #backToTop {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #444;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 20px;
            cursor: pointer;
            display: none;
            z-index: 100;
        }
        #backToTop:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Movies by Popularity</h1>
        <div id="headerButtons">
            <button onclick="location.href='filters.html'">Filters</button>
            <button id="clearBtn">Clear</button>
            <button id="undoBtn">Undo Skip</button>
        </div>
    </div>
    <div id="errorBox"></div>
    <div id="movieList"><p>Loading...</p></div>
    <button id="backToTop">↑</button>

    <script>
        const apiKey = 'Add-Your-API'; // <-- Your tested API key
        let seen = new Set();
        let excluded = new Set();
        let favorites = new Set();
        let sortedFavorites = [];
        let selectedGenres = JSON.parse(localStorage.getItem('selectedGenres')) || [];
        let selectedMoods = JSON.parse(localStorage.getItem('selectedMoods')) || [];
        let searchQuery = localStorage.getItem('searchQuery') || '';
        let actorQuery = localStorage.getItem('actorQuery') || '';
        let minYear = localStorage.getItem('minYear') || '';
        let maxYear = localStorage.getItem('maxYear') || '';
        let appPage = 1;
        let currentPage = 1;
        let maxPages = 0;
        const moviesPerPage = 20;
        let isLoading = false;
        let lastSkippedId = null;
        const movieList = document.getElementById('movieList');
        const errorBox = document.getElementById('errorBox');
        const undoBtn = document.getElementById('undoBtn');
        const backToTop = document.getElementById('backToTop');

        function showError(msg) {
            errorBox.textContent = msg;
            errorBox.style.display = 'block';
        }

        function loadExcluded() {
            const stored = localStorage.getItem('excludedMovies');
            if (stored) excluded = new Set(JSON.parse(stored));
        }

        function saveExcluded() {
            localStorage.setItem('excludedMovies', JSON.stringify(Array.from(excluded)));
        }

        function loadFavorites() {
            const stored = localStorage.getItem('favoriteMovies');
            if (stored) favorites = new Set(JSON.parse(stored));
        }

        function saveFavorites() {
            localStorage.setItem('favoriteMovies', JSON.stringify(Array.from(favorites)));
        }

        async function updateSortedFavorites() {
            const favIds = Array.from(favorites);
            if (favIds.length === 0) {
                sortedFavorites = [];
                return;
            }
            const promises = favIds.map(getMovieDetails);
            const movies = await Promise.all(promises);
            sortedFavorites = movies.filter(m => m !== null);
            sortedFavorites.sort((a, b) => {
                if (a.vote_average !== b.vote_average) return b.vote_average - a.vote_average;
                return b.popularity - a.popularity;
            });
        }

        async function getMovieDetails(id) {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${apiKey}`);
                const data = await response.json();
                if (data.status_code) return null;
                return data;
            } catch (err) {
                return null;
            }
        }

        function toggleFavorite(movieId, buttonElement) {
            const wasFavorite = favorites.has(movieId);
            if (wasFavorite) {
                favorites.delete(movieId);
                buttonElement.innerHTML = '♡';
                buttonElement.style.color = 'white';
            } else {
                favorites.add(movieId);
                buttonElement.innerHTML = '♥';
                buttonElement.style.color = 'red';
            }
            saveFavorites();
            const isNowFavorite = !wasFavorite;
            const rightSide = buttonElement.parentElement;
            let excludeBtn = rightSide.querySelector('.exclude-btn');
            if (isNowFavorite) {
                if (excludeBtn) excludeBtn.remove();
            } else {
                if (!excludeBtn) {
                    excludeBtn = document.createElement('button');
                    excludeBtn.className = 'exclude-btn';
                    excludeBtn.innerHTML = 'Seen/Skip';
                    excludeBtn.onclick = () => excludeMovie(movieId, rightSide.parentElement);
                    rightSide.insertBefore(excludeBtn, rightSide.firstChild);
                }
            }
        }

        function excludeMovie(movieId, liElement) {
            lastSkippedId = movieId;
            if (favorites.has(movieId)) {
                favorites.delete(movieId);
                saveFavorites();
            }
            excluded.add(movieId);
            seen.add(movieId);
            saveExcluded();
            liElement.remove();
        }

        function clearFilters() {
            selectedGenres = [];
            localStorage.setItem('selectedGenres', JSON.stringify([]));
            selectedMoods = [];
            localStorage.setItem('selectedMoods', JSON.stringify([]));
            searchQuery = '';
            localStorage.setItem('searchQuery', '');
            actorQuery = '';
            localStorage.setItem('actorQuery', '');
            minYear = '';
            localStorage.setItem('minYear', '');
            maxYear = '';
            localStorage.setItem('maxYear', '');
            seen.clear();
            appPage = 1;
            currentPage = 1;
            maxPages = 0;
            movieList.innerHTML = '';
            loadMovies();
        }

        function loadNext() {
            appPage++;
            loadMovies(true);
        }

        async function loadMovies(append = false) {
            if (isLoading) return;
            isLoading = true;
            errorBox.style.display = 'none';
            if (!append) movieList.innerHTML = '<p>Loading...</p>';
            let favMovies = [];
            let numFav = 0;
            if (!searchQuery) {
                const favStart = (appPage - 1) * moviesPerPage;
                favMovies = sortedFavorites.slice(favStart, favStart + moviesPerPage);
                numFav = favMovies.length;
            }
            let numNewNeeded = moviesPerPage - numFav;
            let newMovies = [];
            if (numNewNeeded > 0) {
                let gteStr = '';
                let lteStr = '';
                if (minYear) gteStr = `&primary_release_date.gte=${minYear}-01-01`;
                if (maxYear) lteStr = `&primary_release_date.lte=${maxYear}-12-31`;
                let dateFilter = gteStr + lteStr;
                let genreParam = '';
                if (selectedGenres.length > 0 && !searchQuery) genreParam = `&with_genres=${selectedGenres.join(',')}`;
                let moodParam = '';
                if (selectedMoods.length > 0 && !searchQuery) moodParam = `&with_keywords=${selectedMoods.join(',')}`;
                let peopleParam = '';
                if (actorQuery && !searchQuery) {
                    const names = actorQuery.split(',').map(n => n.trim()).filter(n => n);
                    let peopleIds = [];
                    for (let name of names) {
                        try {
                            const response = await fetch(`https://api.themoviedb.org/3/search/person?api_key=${apiKey}&query=${encodeURIComponent(name)}`);
                            const data = await response.json();
                            if (data.results && data.results.length > 0) {
                                const person = data.results.sort((a, b) => b.popularity - a.popularity)[0];
                                peopleIds.push(person.id);
                            }
                        } catch {}
                    }
                    if (peopleIds.length > 0) {
                        peopleParam = `&with_people=${peopleIds.join(',')}`;
                    }
                }
                let attempts = 0;
                const maxAttempts = 50;
                let baseUrl;
                if (searchQuery) {
                    baseUrl = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(searchQuery)}&with_original_language=en&region=US`;
                    if (minYear && minYear === maxYear) {
                        baseUrl += `&primary_release_year=${minYear}`;
                    }
                } else {
                    baseUrl = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}${dateFilter}${genreParam}${moodParam}${peopleParam}&sort_by=popularity.desc&with_original_language=en&region=US`;
                }
                while (newMovies.length < numNewNeeded && attempts < maxAttempts && (maxPages === 0 || currentPage <= maxPages)) {
                    attempts++;
                    try {
                        const response = await fetch(`${baseUrl}&page=${currentPage}`);
                        const data = await response.json();
                        if (data.status_code) {
                            showError(`TMDB Error: ${data.status_message}`);
                            movieList.innerHTML = '';
                            isLoading = false;
                            return;
                        }
                        if (data.total_pages > maxPages) maxPages = data.total_pages;
                        if (!data.results || data.results.length === 0) {
                            currentPage++;
                            continue;
                        }
                        const potential = data.results.filter(movie => !seen.has(movie.id) && !excluded.has(movie.id));
                        newMovies = newMovies.concat(potential);
                        currentPage++;
                    } catch (err) {
                        showError(`Network error: ${err.message}`);
                        movieList.innerHTML = '';
                        isLoading = false;
                        return;
                    }
                }
                newMovies = newMovies.slice(0, numNewNeeded);
                if (!searchQuery) {
                    newMovies.sort((a, b) => {
                        const aHasVote = a.vote_average > 0 ? 1 : 0;
                        const bHasVote = b.vote_average > 0 ? 1 : 0;
                        if (aHasVote !== bHasVote) return bHasVote - aHasVote;
                        const aHasPoster = a.poster_path ? 1 : 0;
                        const bHasPoster = b.poster_path ? 1 : 0;
                        return bHasPoster - aHasPoster;
                    });
                }
            }
            const allMovies = [...favMovies, ...newMovies];
            allMovies.forEach(movie => seen.add(movie.id));

            let html = '';
            if (allMovies.length > 0) {
                html += '<ul>';
                allMovies.forEach(movie => {
                    const posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w154${movie.poster_path}` : '';
                    const isFavorite = favorites.has(movie.id);
                    html += `
                        <li data-movie-id="${movie.id}">
                            <div class="poster">
                                ${posterUrl ? `<img src="${posterUrl}" alt="${movie.title} poster">` : '<div class="placeholder">?</div>'}
                            </div>
                            <div class="middle">
                                <h3>${movie.title} (${movie.release_date || 'N/A'})</h3>
                                <p class="overview">${movie.overview || 'No overview available.'}</p>
                            </div>
                            <div class="right-side">
                                ${!isFavorite ? `<button class="exclude-btn" onclick="excludeMovie(${movie.id}, this.parentElement.parentElement)">Seen/Skip</button>` : ''}
                                <p class="rating">Rating: ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</p>
                                <button class="favorite-btn" onclick="toggleFavorite(${movie.id}, this)" style="background: none; border: none; font-size: 1.5em; color: ${isFavorite ? 'red' : 'white'};">
                                    ${isFavorite ? '♥' : '♡'}
                                </button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
            } else {
                html = '<p>No movies found.</p>';
            }
            if (append) {
                movieList.innerHTML += html;
            } else {
                movieList.innerHTML = html;
            }
            setupOverviews();
            isLoading = false;
        }

        function setupOverviews() {
            const overviews = document.querySelectorAll('.overview');
            overviews.forEach(ov => {
                ov.style.maxHeight = '154px';
                ov.style.overflow = 'hidden';
                const isOverflow = ov.scrollHeight > ov.clientHeight;
                let ellipsis = null;
                if (isOverflow) {
                    ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.position = 'absolute';
                    ellipsis.style.bottom = '0';
                    ellipsis.style.right = '0';
                    ellipsis.style.backgroundColor = '#121212';
                    ellipsis.style.color = '#e0e0e0';
                    ov.appendChild(ellipsis);
                }
                ov.addEventListener('click', () => {
                    if (ov.style.maxHeight !== 'none') {
                        ov.style.maxHeight = 'none';
                        ov.style.overflow = 'visible';
                        if (ellipsis) {
                            ellipsis.remove();
                            ellipsis = null;
                        }
                    } else {
                        ov.style.maxHeight = '154px';
                        ov.style.overflow = 'hidden';
                        const nowOverflow = ov.scrollHeight > ov.clientHeight;
                        if (nowOverflow && !ellipsis) {
                            ellipsis = document.createElement('span');
                            ellipsis.textContent = '...';
                            ellipsis.style.position = 'absolute';
                            ellipsis.style.bottom = '0';
                            ellipsis.style.right = '0';
                            ellipsis.style.backgroundColor = '#121212';
                            ellipsis.style.color = '#e0e0e0';
                            ov.appendChild(ellipsis);
                        }
                    }
                });
            });
        }

        undoBtn.onclick = async function() {
            if (!lastSkippedId) return;
            excluded.delete(lastSkippedId);
            seen.delete(lastSkippedId);
            saveExcluded();
            const movie = await getMovieDetails(lastSkippedId);
            if (movie) {
                const posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w154${movie.poster_path}` : '';
                const isFavorite = favorites.has(movie.id);
                const html = `
                    <li data-movie-id="${movie.id}">
                        <div class="poster">
                            ${posterUrl ? `<img src="${posterUrl}" alt="${movie.title} poster">` : '<div class="placeholder">?</div>'}
                        </div>
                        <div class="middle">
                            <h3>${movie.title} (${movie.release_date || 'N/A'})</h3>
                            <p class="overview">${movie.overview || 'No overview available.'}</p>
                        </div>
                        <div class="right-side">
                            ${!isFavorite ? `<button class="exclude-btn" onclick="excludeMovie(${movie.id}, this.parentElement.parentElement)">Seen/Skip</button>` : ''}
                            <p class="rating">Rating: ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</p>
                            <button class="favorite-btn" onclick="toggleFavorite(${movie.id}, this)" style="background: none; border: none; font-size: 1.5em; color: ${isFavorite ? 'red' : 'white'};">
                                ${isFavorite ? '♥' : '♡'}
                            </button>
                        </div>
                    </li>
                `;
                const ul = movieList.querySelector('ul');
                if (ul) {
                    ul.insertAdjacentHTML('afterbegin', html);
                } else {
                    movieList.innerHTML = '<ul>' + html + '</ul>';
                }
                setupOverviews();
            }
            lastSkippedId = null;
        };

        backToTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        (async () => {
            loadExcluded();
            loadFavorites();
            await updateSortedFavorites();

            document.getElementById('clearBtn').onclick = clearFilters;

            await loadMovies();

            // Infinite scroll and back to top
            window.addEventListener('scroll', () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !isLoading) {
                    loadNext();
                }
                if (window.scrollY > 300) {
                    backToTop.style.display = 'block';
                } else {
                    backToTop.style.display = 'none';
                }
            });
        })();
    </script>
</body>
</html>
